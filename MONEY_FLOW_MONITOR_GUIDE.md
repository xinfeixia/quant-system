# 资金流入监控系统使用指南

## 📋 功能概述

资金流入监控系统是一个**分钟级别**的实时监控工具，用于检测股票市场中的大量资金流入情况，并通过邮件及时提醒投资者。

### 核心功能

1. ✅ **分钟级别监控**：每分钟获取股票的实时行情数据
2. ✅ **资金流入检测**：自动计算成交量、成交额倍数，识别异常资金流入
3. ✅ **邮件告警**：当检测到大量资金涌入时，自动发送邮件提醒
4. ✅ **智能筛选**：自动监控高分股票（评分>=70），也可手动指定监控列表
5. ✅ **数据存储**：保存分钟数据和告警记录，便于后续分析

---

## 🚀 快速开始

### 1. 配置邮件通知

编辑 `config/config.yaml`，配置邮件参数：

```yaml
notification:
  enabled: true
  
  email:
    enabled: true
    smtp_server: smtp.gmail.com      # SMTP服务器
    smtp_port: 587                    # SMTP端口
    username: your_email@gmail.com    # 邮箱账号
    password: your_app_password       # 邮箱密码或应用专用密码
    from_addr: your_email@gmail.com   # 发件人地址
    to_addrs:
      - recipient1@example.com        # 收件人1
      - recipient2@example.com        # 收件人2（可选）
```

**注意事项：**
- **Gmail用户**：需要开启"两步验证"并生成"应用专用密码"
- **QQ邮箱用户**：需要开启SMTP服务并使用"授权码"作为密码
- **163邮箱用户**：smtp_server改为`smtp.163.com`

### 2. 配置监控参数

编辑 `config/config.yaml`，配置监控参数：

```yaml
money_flow_monitor:
  enabled: true                      # 启用监控
  interval: 60                       # 监控间隔（秒），建议60-300秒
  lookback_minutes: 30               # 回溯时间（分钟），用于计算平均值
  
  # 告警阈值
  volume_ratio_threshold: 3.0        # 成交量倍数阈值（3倍）
  turnover_ratio_threshold: 3.0      # 成交额倍数阈值（3倍）
  price_change_threshold: 0.05       # 价格变动阈值（5%）
```

**参数说明：**
- `interval`: 监控间隔，建议60-300秒，太短会增加API调用频率
- `lookback_minutes`: 回溯时间，用于计算平均成交量/成交额，建议30-60分钟
- `volume_ratio_threshold`: 成交量倍数阈值，当前成交量/平均成交量 >= 3.0时触发告警
- `turnover_ratio_threshold`: 成交额倍数阈值，当前成交额/平均成交额 >= 3.0时触发告警
- `price_change_threshold`: 价格变动阈值，价格变动 >= 5%时触发告警

### 3. 测试邮件配置

在启动监控前，先测试邮件配置是否正确：

```bash
cd longport-quant-system
python scripts/monitor_money_flow.py --test-email
```

如果配置正确，您将收到一封测试邮件。

### 4. 启动监控

#### 方式1：自动监控高分股票

系统会自动从最新选股结果中选择评分>=70的股票进行监控：

```bash
python scripts/monitor_money_flow.py
```

#### 方式2：手动指定监控股票

```bash
python scripts/monitor_money_flow.py --symbols 0700.HK 9988.HK 0941.HK
```

#### 方式3：自定义监控间隔

```bash
python scripts/monitor_money_flow.py --interval 120
```

---

## 📊 监控逻辑

### 告警触发条件

系统会在以下情况下触发告警：

1. **成交量激增**：当前成交量 >= 平均成交量 × 3.0
2. **成交额激增**：当前成交额 >= 平均成交额 × 3.0
3. **价格异动**：价格变动 >= 5%
4. **综合异动**：成交量和成交额都超过阈值的80%

### 计算方法

```
成交量倍数 = 当前1分钟成交量 / 过去30分钟平均成交量
成交额倍数 = 当前1分钟成交额 / 过去30分钟平均成交额
价格变动% = (当前价格 - 30分钟前价格) / 30分钟前价格 × 100
```

### 告警去重

系统会自动去重，同一只股票在5分钟内只会发送一次告警邮件。

---

## 📧 邮件告警示例

当检测到资金流入时，您将收到如下格式的邮件：

**主题：** 🚨 资金流入告警 - 2025-10-23 14:30:00

**内容：**

| 股票代码 | 股票名称 | 告警类型 | 当前价格 | 价格变动 | 成交量倍数 | 成交额倍数 | 告警时间 |
|---------|---------|---------|---------|---------|-----------|-----------|---------|
| 0700.HK | 腾讯控股 | 成交量激增 | ¥350.00 | +3.50% | **5.2x** | **4.8x** | 2025-10-23 14:30:00 |
| 9988.HK | 阿里巴巴 | 综合异动 | ¥85.00 | +2.10% | **3.5x** | **3.2x** | 2025-10-23 14:31:00 |

---

## 🗄️ 数据库表结构

### MinuteData（分钟数据表）

存储分钟级别的K线数据：

| 字段 | 类型 | 说明 |
|------|------|------|
| symbol | String | 股票代码 |
| trade_datetime | DateTime | 交易时间（精确到分钟） |
| open | Float | 开盘价 |
| high | Float | 最高价 |
| low | Float | 最低价 |
| close | Float | 收盘价 |
| volume | Float | 成交量 |
| turnover | Float | 成交额 |

### MoneyFlowAlert（资金流入告警表）

存储告警记录：

| 字段 | 类型 | 说明 |
|------|------|------|
| symbol | String | 股票代码 |
| alert_datetime | DateTime | 告警时间 |
| alert_type | String | 告警类型 |
| current_volume | Float | 当前成交量 |
| avg_volume | Float | 平均成交量 |
| volume_ratio | Float | 成交量倍数 |
| current_turnover | Float | 当前成交额 |
| avg_turnover | Float | 平均成交额 |
| turnover_ratio | Float | 成交额倍数 |
| price_change_pct | Float | 价格变动百分比 |
| current_price | Float | 当前价格 |
| is_sent | Boolean | 是否已发送邮件 |

---

## 🔧 常见问题

### 1. 邮件发送失败

**问题：** 提示"邮件发送失败"

**解决方案：**
- 检查邮箱账号和密码是否正确
- Gmail用户需要使用"应用专用密码"，不是登录密码
- QQ邮箱用户需要使用"授权码"
- 检查SMTP服务器和端口是否正确
- 检查网络连接是否正常

### 2. 监控列表为空

**问题：** 提示"监控列表为空，无法启动监控"

**解决方案：**
- 先运行选股分析：`python scripts/run_stock_selection.py --market CN --min-score 50`
- 或手动指定监控股票：`python scripts/monitor_money_flow.py --symbols 0700.HK 9988.HK`

### 3. API调用频率限制

**问题：** 提示"API调用频率超限"

**解决方案：**
- 增加监控间隔：`--interval 300`（5分钟）
- 减少监控股票数量
- 检查LongPort API配额

### 4. 没有收到告警邮件

**问题：** 监控正常运行，但没有收到邮件

**可能原因：**
- 没有股票触发告警条件（成交量/成交额未达到阈值）
- 邮件配置未启用：检查`notification.email.enabled`是否为`true`
- 邮件被拦截：检查垃圾邮件文件夹
- 告警去重：同一股票5分钟内只发送一次

---

## 📈 使用建议

### 1. 监控间隔设置

- **激进型**：60秒（1分钟），适合短线交易者
- **稳健型**：180秒（3分钟），适合中短线交易者
- **保守型**：300秒（5分钟），适合中长线交易者

### 2. 阈值设置

- **高灵敏度**：成交量/成交额倍数设为2.0，价格变动设为3%
- **中等灵敏度**：成交量/成交额倍数设为3.0，价格变动设为5%（推荐）
- **低灵敏度**：成交量/成交额倍数设为5.0，价格变动设为8%

### 3. 监控时间

建议只在交易时间内运行监控：
- **A股**：09:30-11:30, 13:00-15:00
- **港股**：09:30-12:00, 13:00-16:00

可以使用系统的定时任务功能，在交易时间自动启动/停止监控。

---

## 🎯 下一步

1. **回测验证**：分析历史告警记录，优化阈值参数
2. **策略整合**：将资金流入信号整合到交易策略中
3. **多维度监控**：结合技术指标、新闻舆情等多维度信号
4. **自动交易**：基于资金流入信号自动下单（需谨慎）

---

## ⚠️ 风险提示

1. **资金流入不等于上涨**：大量资金流入可能是主力出货，需结合其他指标判断
2. **虚假信号**：短期成交量激增可能是偶然事件，不一定有持续性
3. **延迟问题**：分钟数据有一定延迟，可能错过最佳买入时机
4. **API限制**：频繁调用API可能触发限流，影响监控效果

**投资有风险，入市需谨慎！**

