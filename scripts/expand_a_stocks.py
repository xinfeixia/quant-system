"""
æ‰©å±•Aè‚¡è‚¡ç¥¨æ±  - æ·»åŠ æ›´å¤šæŒ‡æ•°æˆåˆ†è‚¡
åŒ…å«ä¸Šè¯50ã€ä¸­è¯500ã€æ·±è¯æˆæŒ‡ã€è¡Œä¸šé¾™å¤´ç­‰
"""
import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent))

from database import init_database, get_db_manager
from database.models import StockInfo
from data_collection.longport_client import init_longport_client, get_longport_client
from utils.config_loader import init_config
from loguru import logger


# ä¸Šè¯50æˆåˆ†è‚¡ï¼ˆ50åªè“ç­¹è‚¡ï¼‰
SSE50_STOCKS = {
    # é‡‘è
    '600036.SH': 'æ‹›å•†é“¶è¡Œ',
    '601318.SH': 'ä¸­å›½å¹³å®‰',
    '600000.SH': 'æµ¦å‘é“¶è¡Œ',
    '601166.SH': 'å…´ä¸šé“¶è¡Œ',
    '600016.SH': 'æ°‘ç”Ÿé“¶è¡Œ',
    '601328.SH': 'äº¤é€šé“¶è¡Œ',
    '601398.SH': 'å·¥å•†é“¶è¡Œ',
    '601939.SH': 'å»ºè®¾é“¶è¡Œ',
    '601288.SH': 'å†œä¸šé“¶è¡Œ',
    '601988.SH': 'ä¸­å›½é“¶è¡Œ',
    '601601.SH': 'ä¸­å›½å¤ªä¿',
    '601628.SH': 'ä¸­å›½äººå¯¿',
    '601688.SH': 'åæ³°è¯åˆ¸',
    '600030.SH': 'ä¸­ä¿¡è¯åˆ¸',
    
    # æ¶ˆè´¹
    '600519.SH': 'è´µå·èŒ…å°',
    '600887.SH': 'ä¼Šåˆ©è‚¡ä»½',
    '603288.SH': 'æµ·å¤©å‘³ä¸š',
    '600809.SH': 'å±±è¥¿æ±¾é…’',
    
    # åŒ»è¯
    '600276.SH': 'æ’ç‘åŒ»è¯',
    '603259.SH': 'è¯æ˜åº·å¾·',
    
    # èƒ½æº
    '600028.SH': 'ä¸­å›½çŸ³åŒ–',
    '601857.SH': 'ä¸­å›½çŸ³æ²¹',
    '601088.SH': 'ä¸­å›½ç¥å',
    '600309.SH': 'ä¸‡ååŒ–å­¦',
    
    # å·¥ä¸š
    '600585.SH': 'æµ·èºæ°´æ³¥',
    '601668.SH': 'ä¸­å›½å»ºç­‘',
    '601390.SH': 'ä¸­å›½ä¸­é“',
    '601186.SH': 'ä¸­å›½é“å»º',
    
    # ç§‘æŠ€
    '600745.SH': 'é—»æ³°ç§‘æŠ€',
    '688981.SH': 'ä¸­èŠ¯å›½é™…',
    
    # å…¶ä»–
    '601888.SH': 'ä¸­å›½ä¸­å…',
    '600690.SH': 'æµ·å°”æ™ºå®¶',
    '601012.SH': 'éš†åŸºç»¿èƒ½',
    '601899.SH': 'ç´«é‡‘çŸ¿ä¸š',
    '600031.SH': 'ä¸‰ä¸€é‡å·¥',
    '601919.SH': 'ä¸­è¿œæµ·æ§',
    '600900.SH': 'é•¿æ±Ÿç”µåŠ›',
    '601225.SH': 'é™•è¥¿ç…¤ä¸š',
    '601336.SH': 'æ–°åä¿é™©',
}

# ä¸­è¯500æˆåˆ†è‚¡ï¼ˆç²¾é€‰50åªä¸­ç›˜æˆé•¿è‚¡ï¼‰
CSI500_STOCKS = {
    # ç§‘æŠ€
    '002049.SZ': 'ç´«å…‰å›½å¾®',
    '002230.SZ': 'ç§‘å¤§è®¯é£',
    '002236.SZ': 'å¤§åè‚¡ä»½',
    '002352.SZ': 'é¡ºä¸°æ§è‚¡',
    '002410.SZ': 'å¹¿è”è¾¾',
    '002456.SZ': 'æ¬§è²å…‰',
    '002508.SZ': 'è€æ¿ç”µå™¨',
    '002555.SZ': 'ä¸‰ä¸ƒäº’å¨±',
    '002600.SZ': 'é¢†ç›Šæ™ºé€ ',
    '002648.SZ': 'å«æ˜ŸåŒ–å­¦',
    '002714.SZ': 'ç‰§åŸè‚¡ä»½',
    '002916.SZ': 'æ·±å—ç”µè·¯',
    '002920.SZ': 'å¾·èµ›è¥¿å¨',
    
    # åŒ»è¯
    '002821.SZ': 'å‡¯è±è‹±',
    '300003.SZ': 'ä¹æ™®åŒ»ç–—',
    '300142.SZ': 'æ²ƒæ£®ç”Ÿç‰©',
    '300529.SZ': 'å¥å¸†ç”Ÿç‰©',
    '300595.SZ': 'æ¬§æ™®åº·è§†',
    '300676.SZ': 'åå¤§åŸºå› ',
    
    # æ¶ˆè´¹
    '002027.SZ': 'åˆ†ä¼—ä¼ åª’',
    '002032.SZ': 'è‹æ³Šå°”',
    '002120.SZ': 'éŸµè¾¾è‚¡ä»½',
    '002142.SZ': 'å®æ³¢é“¶è¡Œ',
    '002153.SZ': 'çŸ³åŸºä¿¡æ¯',
    '002179.SZ': 'ä¸­èˆªå…‰ç”µ',
    '002271.SZ': 'ä¸œæ–¹é›¨è™¹',
    '002311.SZ': 'æµ·å¤§é›†å›¢',
    '002372.SZ': 'ä¼Ÿæ˜Ÿæ–°æ',
    '002384.SZ': 'ä¸œå±±ç²¾å¯†',
    
    # æ–°èƒ½æº
    '002129.SZ': 'ä¸­ç¯è‚¡ä»½',
    '002459.SZ': 'æ™¶æ¾³ç§‘æŠ€',
    '002812.SZ': 'æ©æ·è‚¡ä»½',
    '300124.SZ': 'æ±‡å·æŠ€æœ¯',
    '300274.SZ': 'é˜³å…‰ç”µæº',
    '300450.SZ': 'å…ˆå¯¼æ™ºèƒ½',
    
    # åŒ–å·¥
    '002601.SZ': 'é¾™ä½°é›†å›¢',
    '002756.SZ': 'æ°¸å…´ææ–™',
    '600426.SH': 'åé²æ’å‡',
    '600438.SH': 'é€šå¨è‚¡ä»½',
    '603799.SH': 'åå‹é’´ä¸š',
    
    # å…¶ä»–
    '600132.SH': 'é‡åº†å•¤é…’',
    '600346.SH': 'æ’åŠ›çŸ³åŒ–',
    '600570.SH': 'æ’ç”Ÿç”µå­',
    '600703.SH': 'ä¸‰å®‰å…‰ç”µ',
    '600760.SH': 'ä¸­èˆªæ²ˆé£',
    '603986.SH': 'å…†æ˜“åˆ›æ–°',
    '688111.SH': 'é‡‘å±±åŠå…¬',
    '688599.SH': 'å¤©åˆå…‰èƒ½',
}

# æ·±è¯æˆæŒ‡æˆåˆ†è‚¡ï¼ˆç²¾é€‰30åªï¼‰
SZSE_STOCKS = {
    '000001.SZ': 'å¹³å®‰é“¶è¡Œ',
    '000002.SZ': 'ä¸‡ç§‘A',
    '000063.SZ': 'ä¸­å…´é€šè®¯',
    '000100.SZ': 'TCLç§‘æŠ€',
    '000333.SZ': 'ç¾çš„é›†å›¢',
    '000338.SZ': 'æ½æŸ´åŠ¨åŠ›',
    '000425.SZ': 'å¾å·¥æœºæ¢°',
    '000651.SZ': 'æ ¼åŠ›ç”µå™¨',
    '000661.SZ': 'é•¿æ˜¥é«˜æ–°',
    '000725.SZ': 'äº¬ä¸œæ–¹A',
    '000858.SZ': 'äº”ç²®æ¶²',
    '000876.SZ': 'æ–°å¸Œæœ›',
    '000938.SZ': 'ç´«å…‰è‚¡ä»½',
    '001979.SZ': 'æ‹›å•†è›‡å£',
    '002027.SZ': 'åˆ†ä¼—ä¼ åª’',
    '002142.SZ': 'å®æ³¢é“¶è¡Œ',
    '002230.SZ': 'ç§‘å¤§è®¯é£',
    '002241.SZ': 'æ­Œå°”è‚¡ä»½',
    '002352.SZ': 'é¡ºä¸°æ§è‚¡',
    '002415.SZ': 'æµ·åº·å¨è§†',
    '002475.SZ': 'ç«‹è®¯ç²¾å¯†',
    '002594.SZ': 'æ¯”äºšè¿ª',
    '002714.SZ': 'ç‰§åŸè‚¡ä»½',
    '300014.SZ': 'äº¿çº¬é”‚èƒ½',
    '300059.SZ': 'ä¸œæ–¹è´¢å¯Œ',
    '300124.SZ': 'æ±‡å·æŠ€æœ¯',
    '300274.SZ': 'é˜³å…‰ç”µæº',
    '300750.SZ': 'å®å¾·æ—¶ä»£',
    '300760.SZ': 'è¿ˆç‘åŒ»ç–—',
    '301029.SZ': 'æ€¡åˆè¾¾',
}

# è¡Œä¸šé¾™å¤´è‚¡ç¥¨ï¼ˆå„è¡Œä¸šä»£è¡¨ï¼‰
SECTOR_LEADERS = {
    # åŠå¯¼ä½“
    '603501.SH': 'éŸ¦å°”è‚¡ä»½',
    '688008.SH': 'æ¾œèµ·ç§‘æŠ€',
    '688012.SH': 'ä¸­å¾®å…¬å¸',
    '688036.SH': 'ä¼ éŸ³æ§è‚¡',
    '688041.SH': 'æµ·å…‰ä¿¡æ¯',
    '688126.SH': 'æ²ªç¡…äº§ä¸š',
    '688256.SH': 'å¯’æ­¦çºª',
    '688396.SH': 'åæ¶¦å¾®',
    
    # æ–°ææ–™
    '002460.SZ': 'èµ£é”‹é”‚ä¸š',
    '002466.SZ': 'å¤©é½é”‚ä¸š',
    '002812.SZ': 'æ©æ·è‚¡ä»½',
    '300450.SZ': 'å…ˆå¯¼æ™ºèƒ½',
    
    # å†›å·¥
    '600760.SH': 'ä¸­èˆªæ²ˆé£',
    '600893.SH': 'èˆªå‘åŠ¨åŠ›',
    '002179.SZ': 'ä¸­èˆªå…‰ç”µ',
    
    # é€šä¿¡
    '600050.SH': 'ä¸­å›½è”é€š',
    '600941.SH': 'ä¸­å›½ç§»åŠ¨',
    
    # ç”µåŠ›
    '600900.SH': 'é•¿æ±Ÿç”µåŠ›',
    '600905.SH': 'ä¸‰å³¡èƒ½æº',
    
    # ç…¤ç‚­
    '601225.SH': 'é™•è¥¿ç…¤ä¸š',
    '601088.SH': 'ä¸­å›½ç¥å',
    
    # æœ‰è‰²
    '601899.SH': 'ç´«é‡‘çŸ¿ä¸š',
    '603799.SH': 'åå‹é’´ä¸š',
    
    # å»ºæ
    '600585.SH': 'æµ·èºæ°´æ³¥',
    '002271.SZ': 'ä¸œæ–¹é›¨è™¹',
    
    # å®¶ç”µ
    '600690.SH': 'æµ·å°”æ™ºå®¶',
    '002032.SZ': 'è‹æ³Šå°”',
    
    # é£Ÿå“é¥®æ–™
    '600132.SH': 'é‡åº†å•¤é…’',
    '002311.SZ': 'æµ·å¤§é›†å›¢',
    
    # å†œä¸š
    '002714.SZ': 'ç‰§åŸè‚¡ä»½',
    '000876.SZ': 'æ–°å¸Œæœ›',
    
    # ä¼ åª’
    '002027.SZ': 'åˆ†ä¼—ä¼ åª’',
    '002555.SZ': 'ä¸‰ä¸ƒäº’å¨±',
    
    # ç‰©æµ
    '002352.SZ': 'é¡ºä¸°æ§è‚¡',
    '002120.SZ': 'éŸµè¾¾è‚¡ä»½',
    
    # é›¶å”®
    '601888.SH': 'ä¸­å›½ä¸­å…',
}


def expand_a_stocks():
    """æ‰©å±•Aè‚¡è‚¡ç¥¨æ± """
    
    # åˆå§‹åŒ–
    config_loader = init_config()
    init_database(config_loader.config)
    init_longport_client(config_loader.api_config)
    
    client = get_longport_client()
    db_manager = get_db_manager()
    
    # åˆå¹¶æ‰€æœ‰è‚¡ç¥¨ï¼ˆå»é‡ï¼‰
    all_stocks = {}
    all_stocks.update(SSE50_STOCKS)
    all_stocks.update(CSI500_STOCKS)
    all_stocks.update(SZSE_STOCKS)
    all_stocks.update(SECTOR_LEADERS)
    
    print(f"\n" + "="*60)
    print(f"å‡†å¤‡æ‰©å±•Aè‚¡è‚¡ç¥¨æ± ")
    print(f"="*60)
    print(f"ä¸Šè¯50æˆåˆ†è‚¡: {len(SSE50_STOCKS)} åª")
    print(f"ä¸­è¯500æˆåˆ†è‚¡: {len(CSI500_STOCKS)} åª")
    print(f"æ·±è¯æˆæŒ‡æˆåˆ†è‚¡: {len(SZSE_STOCKS)} åª")
    print(f"è¡Œä¸šé¾™å¤´è‚¡ç¥¨: {len(SECTOR_LEADERS)} åª")
    print(f"åˆå¹¶åæ€»æ•°: {len(all_stocks)} åª")
    print(f"="*60 + "\n")
    
    added_count = 0
    skipped_count = 0
    error_count = 0
    
    with db_manager.get_session() as session:
        for i, (symbol, name) in enumerate(all_stocks.items(), 1):
            try:
                # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                existing = session.query(StockInfo).filter_by(symbol=symbol).first()
                if existing:
                    print(f"[{i}/{len(all_stocks)}] â­ï¸  {symbol} - {name} (å·²å­˜åœ¨)")
                    skipped_count += 1
                    continue
                
                # ä»é•¿æ¡¥APIè·å–è‚¡ç¥¨ä¿¡æ¯
                try:
                    info_list = client.get_static_info([symbol])
                    if not info_list or len(info_list) == 0:
                        print(f"[{i}/{len(all_stocks)}] âŒ {symbol} - {name} (APIæ— æ•°æ®)")
                        error_count += 1
                        continue
                    
                    info = info_list[0]
                    
                    # åˆ›å»ºè‚¡ç¥¨è®°å½•
                    stock = StockInfo(
                        symbol=symbol,
                        name=info.name_cn or name,
                        market='CN',
                        exchange='SH' if symbol.endswith('.SH') else 'SZ',
                        currency='CNY',
                        lot_size=100
                    )
                    
                    session.add(stock)
                    session.commit()
                    
                    print(f"[{i}/{len(all_stocks)}] âœ… {symbol} - {stock.name}")
                    added_count += 1
                    
                except Exception as e:
                    print(f"[{i}/{len(all_stocks)}] âŒ {symbol} - {name} (é”™è¯¯: {str(e)})")
                    error_count += 1
                    session.rollback()
                    
            except Exception as e:
                print(f"[{i}/{len(all_stocks)}] âŒ {symbol} - {name} (æ•°æ®åº“é”™è¯¯: {str(e)})")
                error_count += 1
                session.rollback()
    
    print(f"\n" + "="*60)
    print(f"Aè‚¡è‚¡ç¥¨æ± æ‰©å±•å®Œæˆï¼")
    print(f"="*60)
    print(f"âœ… æ–°å¢: {added_count} åª")
    print(f"â­ï¸  è·³è¿‡: {skipped_count} åª (å·²å­˜åœ¨)")
    print(f"âŒ å¤±è´¥: {error_count} åª")
    print(f"ğŸ“Š æ€»è®¡: {added_count + skipped_count} åªAè‚¡åœ¨æ•°æ®åº“ä¸­")
    print(f"="*60 + "\n")


if __name__ == '__main__':
    expand_a_stocks()

