# 长桥API频率限制说明

## ⚠️ 当前遇到的问题

### 错误代码: 301607
```
OpenApiException: (code=301607, trace_id=) history kline symbol count out of limit
```

**含义**: 历史K线数据请求超出频率限制

---

## 📊 API限制详情

### 历史K线数据限制

根据实际测试和错误信息，长桥API对历史K线数据有严格的频率限制：

| 限制类型 | 限制值 | 说明 |
|---------|--------|------|
| **时间窗口** | 约1分钟 | 限制在固定时间窗口内 |
| **请求数量** | 约5-10只股票 | 每个时间窗口内可请求的股票数量 |
| **恢复时间** | 未知（可能数小时） | 触发限制后需要等待的时间 |
| **全局限制** | 是 | 跨市场（港股、美股、A股）共享限制 |

### 实时行情限制

- ✅ **静态信息**: 无明显限制
- ✅ **实时报价**: 无明显限制（LV1行情）
- ⚠️ **历史K线**: 严格限制（如上所述）

---

## 🔍 问题分析

### 为什么会触发限制？

1. **之前的港股数据获取**: 已经获取了95只港股的历史数据
2. **全局限制**: API限制是全局的，不区分市场
3. **累积效应**: 短时间内多次请求导致触发限制
4. **恢复时间长**: 触发后需要较长时间才能恢复

### 当前状态

- ✅ **港股**: 95只已有历史数据
- ❌ **A股**: 152只暂时无法获取历史数据（受限）
- ⚠️ **美股**: 52只部分有数据

---

## 💡 解决方案

### 方案1: 等待恢复（推荐）

**操作**: 等待数小时或1天后再尝试获取A股数据

**优点**:
- 最安全的方法
- 不会进一步触发限制
- 可以正常获取数据

**缺点**:
- 需要等待时间
- 无法立即使用A股数据

**建议时间**:
- 等待至少 **6-12小时**
- 或者 **第二天** 再尝试

**执行命令**:
```bash
# 明天或数小时后执行
python scripts/fetch_a_stocks_slowly.py --days 365 --delay 60 --limit 5
```

---

### 方案2: 极慢速获取

**操作**: 使用极长的延迟时间（60-120秒/股票）

**优点**:
- 可能避免触发限制
- 可以持续获取

**缺点**:
- 非常耗时（152只股票需要2.5-5小时）
- 仍可能触发限制

**执行命令**:
```bash
# 每只股票间隔60秒
python scripts/fetch_a_stocks_slowly.py --days 365 --delay 60 --limit 10

# 或者更保守：每只股票间隔120秒
python scripts/fetch_a_stocks_slowly.py --days 365 --delay 120 --limit 5
```

---

### 方案3: 分批分天获取（最佳实践）

**操作**: 每天只获取少量股票（5-10只）

**优点**:
- 最稳妥的方法
- 不会触发限制
- 逐步建立完整数据库

**缺点**:
- 需要多天完成
- 需要手动执行多次

**执行计划**:

```bash
# 第1天：获取前5只A股
python scripts/fetch_a_stocks_slowly.py --days 365 --delay 60 --start-from 0 --limit 5

# 第2天：获取接下来5只
python scripts/fetch_a_stocks_slowly.py --days 365 --delay 60 --start-from 5 --limit 5

# 第3天：获取接下来5只
python scripts/fetch_a_stocks_slowly.py --days 365 --delay 60 --start-from 10 --limit 5

# ... 依此类推，约需30天完成全部152只
```

**时间估算**:
- 每天5只股票
- 152只 ÷ 5 = **约31天**
- 每天10只股票 = **约16天**

---

### 方案4: 使用其他数据源（备选）

如果长桥API限制太严格，可以考虑：

1. **Tushare**: 免费的A股数据接口
2. **AkShare**: 开源的金融数据接口
3. **东方财富**: 公开的行情数据
4. **新浪财经**: 免费的历史数据

**注意**: 这些数据源可能需要额外的集成工作

---

## 📅 当前建议

### 立即可做

1. ✅ **使用现有港股数据**
   ```bash
   # 港股选股（95只有数据）
   python scripts/run_stock_selection.py --market HK --top 50
   ```

2. ✅ **查看港股买卖信号**
   ```
   http://localhost:5000/trading-signals
   ```

3. ✅ **分析港股K线图**
   ```
   http://localhost:5000/kline?symbol=0700.HK
   ```

### 等待后执行

**建议时间**: 明天（2025-10-10）或今晚晚些时候

**执行步骤**:

1. **测试API是否恢复**
   ```bash
   python scripts/test_a_stock_simple.py
   ```

2. **如果恢复，开始获取A股数据**
   ```bash
   # 先获取5只测试
   python scripts/fetch_a_stocks_slowly.py --days 365 --delay 60 --limit 5
   ```

3. **如果成功，继续获取**
   ```bash
   # 继续获取接下来的5只
   python scripts/fetch_a_stocks_slowly.py --days 365 --delay 60 --start-from 5 --limit 5
   ```

---

## 🎯 最佳实践建议

### 数据获取策略

1. **分市场分批获取**
   - 港股: 每天10-20只
   - 美股: 每天10-20只
   - A股: 每天5-10只

2. **使用长延迟**
   - 每只股票间隔: 60-120秒
   - 批次间隔: 5-10分钟

3. **避免高峰时段**
   - 避开交易时间（9:30-16:00）
   - 选择晚上或凌晨获取

4. **监控API状态**
   - 遇到301607错误立即停止
   - 等待至少6小时后重试

### 长期规划

1. **建立定时任务**
   - 每天自动获取少量新股票
   - 每天更新已有股票的最新数据

2. **数据更新策略**
   - 新股票: 获取365天历史数据
   - 已有股票: 只获取最新1-7天数据

3. **备份数据**
   - 定期备份数据库
   - 避免数据丢失

---

## 📞 联系长桥客服

如果频率限制过于严格，可以：

1. 联系长桥客服咨询API限制详情
2. 询问是否可以提升限制
3. 了解付费方案的限制情况

**长桥客服**:
- 官网: https://longportapp.com
- 开发者文档: https://open.longportapp.com/docs

---

## 📊 当前数据状态

### 已有数据
- ✅ **港股**: 95只（有完整历史数据和技术指标）
- ✅ **港股选股**: Top 50已生成
- ⚠️ **美股**: 7只（部分数据）
- ❌ **A股**: 0只（受API限制）

### 待获取数据
- ⏳ **港股**: 41只（新添加的股票）
- ⏳ **美股**: 45只（新添加的股票）
- ⏳ **A股**: 152只（全部）

### 总计
- **股票总数**: 340只
- **有数据**: 95只（28%）
- **待获取**: 245只（72%）

---

## 💡 总结

### 当前情况
- API频率限制已触发
- 需要等待恢复（建议6-12小时或明天）
- 港股数据可以正常使用

### 下一步
1. **今天**: 使用现有港股数据进行分析和选股
2. **明天**: 测试API是否恢复，开始获取A股数据
3. **长期**: 建立每天少量获取的定时任务

### 预期时间
- **快速方案**: 等待恢复后，2-3天获取完A股数据（每天50只）
- **稳妥方案**: 每天5-10只，约16-31天完成
- **最佳方案**: 结合两者，根据API响应调整速度

---

**请耐心等待API限制恢复，明天或今晚晚些时候再尝试获取A股数据！** ⏰

